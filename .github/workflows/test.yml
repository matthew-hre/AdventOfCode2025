name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  vitest:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Nix Cache
        uses: actions/cache@v4
        with:
          path: /nix
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-
      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Setup pnpm Cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-
      - name: pnpm install
        run: nix develop -c pnpm install
      - name: test
        run: nix develop -c pnpm test
      - name: Generate badge data
        id: badges
        run: |
          BADGE_DATA=$(nix develop -c node scripts/generate-badges.js | tail -1)
          DAYS=$(echo $BADGE_DATA | grep -o '"daysCompleted":[0-9]*' | cut -d: -f2)
          TESTS=$(echo $BADGE_DATA | grep -o '"testsCount":[0-9]*' | cut -d: -f2)
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "tests=$TESTS" >> $GITHUB_OUTPUT
          mkdir -p .github
          echo $BADGE_DATA > .github/badge-data.json
      - name: Commit badge data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .github/badge-data.json
          git commit -m "Update badge data" || true
          git push || true
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
